<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visualizar Aposta - MULTI PLAY</title>
  <style>
    body {
      font-family: sans-serif;
      background: #e7ffe3;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    .duelo {
      border-top: 1px solid #ccc;
      padding: 15px 0;
    }
    h2 {
      margin-top: 30px;
      color: #1c681c;
    }
    .status {
      font-weight: bold;
    }
    .ganhou {
      color: green;
    }
    .perdeu {
      color: red;
    }
    .carregando {
      color: orange;
    }
    .final-status {
      margin-top: 30px;
      font-size: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container" id="visualizacao">
    <h2>üîé Carregando aposta...</h2>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA5a-2HzvcljnAfXE7P3ThDnq6m6E568ZA",
      authDomain: "jogo-60a9e.firebaseapp.com",
      databaseURL: "https://jogo-60a9e-default-rtdb.firebaseio.com",
      projectId: "jogo-60a9e",
      storageBucket: "jogo-60a9e.appspot.com",
      messagingSenderId: "352852303591",
      appId: "1:352852303591:web:8083c950047c9026bd8c42"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const container = document.getElementById("visualizacao");
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get("id");

    const token = "5e66c06518f74e779bc07e73ef0266c5";

    async function buscarResultado(idPartida) {
      try {
        const res = await fetch(`https://api.api-futebol.com.br/v1/partidas/${idPartida}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!res.ok) return null;
        const data = await res.json();
        return {
          placarA: data.placar_oficial_mandante,
          placarB: data.placar_oficial_visitante
        };
      } catch {
        return null;
      }
    }

    function verificarResultado(placarA, placarB, escolha) {
      if (placarA == null || placarB == null) return "Aguardando";
      if (escolha === "Casa" && placarA > placarB) return "Ganhou";
      if (escolha === "Fora" && placarB > placarA) return "Ganhou";
      if (escolha === "Empate" && placarA === placarB) return "Ganhou";
      return "Perdeu";
    }

    async function exibirAposta(dados) {
      const selecoes = dados.selecoes || dados.jogos;
      if (!selecoes || !Array.isArray(selecoes) || selecoes.length === 0) {
        container.innerHTML = `<h2>‚ö†Ô∏è Aposta inv√°lida ou sem sele√ß√µes registradas.</h2>`;
        return;
      }

      let html = `
        <h2>üìÑ Aposta de ${dados.nome || 'Apostador'}</h2>
        <p><strong>Data da Aposta:</strong> ${new Date(dados.dataHora || Date.now()).toLocaleString()}</p>
        <hr />
      `;

      const resultados = {};
      for (const jogo of selecoes) {
        if (jogo.idPartida) {
          const r = await buscarResultado(jogo.idPartida);
          if (r) resultados[jogo.idPartida] = r;
        }
      }

      let statusFinal = "Ganhou";
      let ultimoGrupo = "";

      for (const jogo of selecoes) {
        const {
          timeA = jogo.nomeTimeA || "",
          timeB = jogo.nomeTimeB || "",
          escolha = jogo.escolha || "",
          dataHora = jogo.dataHora || jogo.dataHoraJogo || "",
          campeonato = jogo.campeonato || "Campeonato"
        } = jogo;

        const resultado = jogo.idPartida && resultados[jogo.idPartida];
        const placarA = resultado ? resultado.placarA : "-";
        const placarB = resultado ? resultado.placarB : "-";
        const status = resultado
          ? verificarResultado(placarA, placarB, escolha)
          : "Aguardando";

        if (status !== "Ganhou" && status !== "Aguardando") statusFinal = "Perdeu";

        if (ultimoGrupo !== campeonato) {
          html += `<h2>${campeonato}</h2>`;
          ultimoGrupo = campeonato;
        }

        html += `
          <div class="duelo">
            <p><strong>${timeA} x ${timeB}</strong></p>
            <p>üïí ${new Date(dataHora).toLocaleString()}</p>
            <p>üéØ Escolha: <strong>${escolha}</strong></p>
            <p>üèÅ Placar: ${placarA} x ${placarB}</p>
            <p class="status ${status === "Ganhou" ? "ganhou" : status === "Perdeu" ? "perdeu" : "carregando"}">
              ${status}
            </p>
          </div>
        `;
      }

      html += `
        <hr />
        <div class="final-status ${statusFinal === "Ganhou" ? "ganhou" : "perdeu"}">
          Status Final: ${statusFinal === "Ganhou" ? "üéâ Ganhou" : "‚ùå Perdeu"}
        </div>
      `;

      container.innerHTML = html;
    }

    if (!id) {
      container.innerHTML = "<h2>‚ùå ID da aposta ausente na URL.</h2>";
    } else {
      const apostaRef = ref(db, `apostas/${id}`);
      onValue(apostaRef, async (snap) => {
        if (!snap.exists()) {
          container.innerHTML = `<h2>‚ùå Aposta n√£o encontrada para o ID: ${id}</h2>`;
          return;
        }

        const dados = snap.val();
        exibirAposta(dados);
      });
    }
  </script>
</body>
</html>
