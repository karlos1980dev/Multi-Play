<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visualizar Aposta - MULTI PLAY</title>
  <style>
    body {
      font-family: sans-serif;
      background: #e7ffe3;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    .duelo {
      border-top: 1px solid #ccc;
      padding: 15px 0;
      text-align: left;
    }
    h2 {
      margin-top: 30px;
      color: #1c681c;
    }
    .status {
      font-weight: bold;
    }
    .ganhou { color: green; }
    .perdeu { color: red; }
    .carregando { color: orange; }
    .final-status {
      margin-top: 30px;
      font-size: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container" id="visualizacao">
    <h2>üîé Carregando aposta...</h2>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    const firebaseConfig = {
      /* sua config aqui (igual ao anterior) */
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const container = document.getElementById("visualizacao");
    const id = new URLSearchParams(window.location.search).get("id");
    const token = "5e66c06518f74e779bc07e73ef0266c5";

    async function buscarResultado(idPartida) {
      try {
        const res = await fetch(`https://api.api-futebol.com.br/v1/partidas/${idPartida}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!res.ok) return null;
        const data = await res.json();
        return {
          placarA: data.placar_oficial_mandante,
          placarB: data.placar_oficial_visitante
        };
      } catch {
        return null;
      }
    }

    function verificarResultado(a, b, escolha) {
      if (a == null || b == null) return "Aguardando";
      if (escolha === "Casa" && a > b) return "Ganhou";
      if (escolha === "Fora" && b > a) return "Ganhou";
      if (escolha === "Empate" && a === b) return "Ganhou";
      return "Perdeu";
    }

    async function exibirAposta(dados) {
      const selecoes = dados.selecoes || dados.jogos;
      if (!Array.isArray(selecoes) || selecoes.length === 0) {
        container.innerHTML = "<h2>‚ö†Ô∏è Aposta inv√°lida ou sem jogos.</h2>";
        return;
      }

      let html = `
        <h2>üìÑ Aposta de ${dados.nome || "Apostador"}</h2>
        <p><strong>Data da Aposta:</strong> ${new Date(dados.dataHora || Date.now()).toLocaleString("pt-BR")}</p>
        <hr />
      `;

      const resultados = {};
      for (const j of selecoes) {
        if (j.idPartida) {
          const r = await buscarResultado(j.idPartida);
          if (r) resultados[j.idPartida] = r;
        }
      }

      let algumPerdeu = false;
      let aguardando = false;

      let ultimoCampe = "";
      for (const j of selecoes) {
        const timeA = j.nomeTimeA || j.timeA || "Time A";
        const timeB = j.nomeTimeB || j.timeB || "Time B";
        const escolha = j.escolha || "";
        const dt = j.dataHoraJogo || j.dataHora || "";
        const dts = dt ? new Date(dt).toLocaleString("pt-BR") : "-";
        const camp = j.campeonato || "Campeonato";

        const resObj = j.idPartida ? resultados[j.idPartida] : null;
        const placarA = resObj ? resObj.placarA : null;
        const placarB = resObj ? resObj.placarB : null;
        const status = verificarResultado(placarA, placarB, escolha);

        if (status === "Perdeu") algu pe rdeu = true;
        else if (status === "Aguardando") aguardando = true;

        if (camp !== ultimoCampe) {
          html += `<h2>üèÜ ${camp}</h2>`;
          ultimoCampe = camp;
        }

        html += `
          <div class="duelo">
            <p><strong>${timeA} x ${timeB}</strong></p>
            <p>üïí ${dts}</p>
            <p>üéØ Escolha: <strong>${escolha}</strong></p>
            <p>üèÅ Placar: ${(placarA!=null?placarA:"-")} x ${(placarB!=null?placarB:"-")}</p>
            <p class="status ${status==="Ganhou"? "ganhou":status==="Perdeu"? "perdeu":"carregando"}">${status}</p>
          </div>`;
      }

      let finalStatus = aguardando ? "‚è≥ Aguardando resultado" : (algumPerdeu ? "‚ùå Perdeu" : "üéâ Ganhou");
      const finalClass = aguardando ? "carregando" : (algumPerdeu ? "perdeu" : "ganhou");

      html += `
        <hr />
        <div class="final-status ${finalClass}">
          Status Final: ${finalStatus}
        </div>
      `;

      container.innerHTML = html;
    }

    if (!id) {
      container.innerHTML = "<h2>‚ùå ID n√£o informado.</h2>";
    } else {
      const apoRef = ref(db, `apostas/${id}`);
      onValue(apoRef, snap => {
        if (!snap.exists()) {
          container.innerHTML = `<h2>‚ùå Aposta n√£o encontrada: ${id}</h2>`;
          return;
        }
        exibirAposta(snap.val());
      });
    }
  </script>
</body>
</html>
